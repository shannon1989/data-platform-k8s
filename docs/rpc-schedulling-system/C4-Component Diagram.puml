@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

Container_Boundary(rpcsys, "RPC Scheduling Subsystem") {

  Component(scheduler, "AsyncRpcScheduler", "asyncio", "Queue-based scheduler\nControls max_queue & max_inflight")

  Component(router, "Web3AsyncRouter", "Provider selection & retry\n(weight + availability)")

  Component(pool, "RpcPool", "Weighted provider ordering")

  Component(provider, "RpcProvider", "RPC endpoint abstraction\nRound-robin key usage")

  Component(slot, "RpcKeySlot", "Sliding-window limiter\n(key_interval)")

  Component(client, "AsyncRpcClient", "aiohttp JSON-RPC client\nNetwork tracing")

  Component(metrics, "Metrics", "Prometheus/Grafana metrics")

}

System_Ext(rpc, "Web3 RPC Provider", "Public / Private RPC")
System_Ext(grafana, "Grafana / Prometheus")

Rel(scheduler, router, "dispatch RPC call")
Rel(router, pool, "pick_providers()")
Rel(pool, provider, "returns ordered providers")
Rel(router, provider, "acquire_slot()")
Rel(provider, slot, "rate limit per key")
Rel(router, client, "call(url, method)")
Rel(client, rpc, "HTTP JSON-RPC")
Rel(scheduler, metrics, "emit runtime metrics")
Rel(metrics, grafana, "visualize")

@enduml