apiVersion: batch/v1
kind: Job
metadata:
  generateName: eth-backfill-job
  namespace: airflow
  labels:
    app: eth-backfill
    component: ingestion
spec:
  # ---------------------------
  # Retry strategy (K8s layer)
  # ---------------------------
  backoffLimit: 3 # Pod-level retry
  completions: 1
  parallelism: 1

  # ---------------------------
  # Garbage collection
  # ---------------------------
  ttlSecondsAfterFinished: 86400   # Auto-delete Job + Pod after 1 day
  template:
    metadata:
      labels:
        app: eth-backfill
        component: ingestion
    spec:
      restartPolicy: Never

      # ---------------------------
      # Scheduling (recommended)
      # ---------------------------
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: workload
                    operator: In
                    values: ["batch"]

      # ---------------------------
      # Security (baseline)
      # ---------------------------
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

      containers:
        - name: eth-backfill
          # ---------------------------
          # Resource management
          # ---------------------------
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "1Gi"

          # ---------------------------
          # Environment variables
          # ---------------------------
          env:
            # ----- Secrets -----
            - name: ETH_ETHERSCAN_API_KEY
              valueFrom:
                secretKeyRef:
                  name: eth-secrets
                  key: ETH_ETHERSCAN_API_KEY

            - name: ETH_INFURA_RPC_URL
              valueFrom:
                secretKeyRef:
                  name: eth-secrets
                  key: ETH_INFURA_RPC_URL

            # ----- Downward API -----
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name